(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[17],{232:function(t,e,a){"use strict";a.r(e);var i=function(){var t=this;var e=t.$createElement;var a=t._self._c||e;return a("div",{directives:[{name:"test",rawName:"v-test",value:"history",expression:"'history'"}],staticClass:"history-list"},[a("div",{staticClass:"history-list-header"},[t._v(t._s(t.$t("任务历史")))]),t._v(" "),a("div",{staticClass:"search-area"},[a("bk-search-select",{directives:[{name:"test",rawName:"v-test.common",value:"searchSelect",expression:"'searchSelect'",modifiers:{common:true}}],ref:"searchSelect",attrs:{data:t.searchSelectData,"show-condition":false},on:{"show-menu":t.handleSearchSelectShowMenu,change:t.handleSearchSelectChange},model:{value:t.searchSelectValue,callback:function(e){t.searchSelectValue=e},expression:"searchSelectValue"}}),t._v(" "),a("bk-date-picker",{directives:[{name:"test",rawName:"v-test",value:"picker",expression:"'picker'"}],attrs:{placeholder:t.$t("选择日期时间范围"),type:"datetimerange"},on:{"pick-success":t.onDataPickerPick,clear:t.handleClearDate},model:{value:t.initDateTimeRange,callback:function(e){t.initDateTimeRange=e},expression:"initDateTimeRange"}})],1),t._v(" "),a("bk-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.isLoading},expression:"{ isLoading }"}],attrs:{"max-height":t.$store.state.pageHeight-187,"ext-cls":"king-table",data:t.tableData,pagination:t.pagination,"row-class-name":t.handlerRowClassName},on:{"sort-change":t.handleSortChange,"row-click":t.handleRowClick,"page-change":t.handlePageChange,"page-limit-change":t.handlePageLimitChange}},[a("bk-table-column",{attrs:{prop:"id",label:t.$t("ID"),width:"90"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",{directives:[{name:"test",rawName:"v-test",value:"viewTask",expression:"'viewTask'"}],staticClass:"button-text"},[t._v(t._s(e.row.id))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"job_object",label:t.$t("任务对象"),"render-header":t.renderFilterHeader},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",[t._v(t._s(t.jobObject[e.row.job_object]))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"job_action",label:t.$t("动作"),"render-header":t.renderFilterHeader},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",[t._v(t._s(t.jobAction[e.row.job_action]))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"job_object",label:t.$t("环境类型")},scopedSlots:t._u([{key:"default",fn:function(e){var i=e.row;return[a("span",[t._v(t._s(t.setEnv[i.expression_scope.bk_set_env]||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"expression",label:t.$t("操作范围"),width:"180"},scopedSlots:t._u([{key:"default",fn:function(e){var i=e.row;return a("div",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}]},[t._v("\n        "+t._s(i.expression)+"\n      ")])}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"created_by",label:t.$t("执行账户"),"render-header":t.renderFilterHeader}}),t._v(" "),a("bk-table-column",{attrs:{prop:"start_time",label:t.$t("开始时间"),sortable:"custom","min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}]},[t._v(t._s(e.row.start_time||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"end_time",label:t.$t("结束时间"),sortable:"custom","min-width":"120"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("div",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}]},[t._v(t._s(e.row.end_time||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"timeout",label:t.$t("执行耗时"),width:"100"},scopedSlots:t._u([{key:"default",fn:function(e){return[a("span",[t._v(t._s(e.row.timeout||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{prop:"status",label:t.$t("执行状态"),"render-header":t.renderFilterHeader},scopedSlots:t._u([{key:"default",fn:function(e){var i=e.row;return[i.status==="succeeded"?a("StatusView",{attrs:{type:"success",text:t.$t("执行成功")}}):i.status==="failed"?a("StatusView",{attrs:{type:"failed",text:t.$t("执行失败")}}):i.status==="running"?a("StatusView",{attrs:{type:"loading",text:t.$t("正在执行")}}):a("StatusView",{attrs:{type:"loading",text:t.$t("等待中")}})]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("操作"),"min-width":"60"},scopedSlots:t._u([{key:"default",fn:function(e){return a("div",{on:{click:function(t){t.stopPropagation()}}},[a("bk-button",{directives:[{name:"test",rawName:"v-test",value:"taskRetry",expression:"'taskRetry'"}],attrs:{disabled:e.row.status!=="failed",theme:"primary",text:""},on:{click:function(a){t.onRetyr(e.row)}}},[t._v("\n          "+t._s(t.$t("重试")))])],1)}}])})],1)],1)};var r=[];var n=a(3);var s=a.n(n);var o=a(13);var c=a.n(o);var l=a(7);var u=a.n(l);var d=a(19);var h=a(636);var p={name:"HistoryList",mixins:[h["a"]],props:{jobObject:{type:Object,default:function t(){return{}}},jobAction:{type:Object,default:function t(){return{}}},setEnv:{type:Object,default:function t(){return{}}}},data:function t(){return{filterData:[{name:this.$t("任务对象"),id:"job_object",children:[],multiable:true},{name:this.$t("动作"),id:"job_action",children:[],multiable:true},{name:this.$t("执行状态"),id:"status",children:[],multiable:true},{name:this.$t("执行账户"),id:"created_by",children:[],multiable:true}],initDateTimeRange:["",""],tableData:[],isLoading:false,pagination:{current:1,count:500,limit:50},ordering:"",runningList:[],selectedIdList:[],historyListTimer:null}},beforeDestroy:function t(){clearTimeout(this.historyListTimer)},created:function t(){var e=sessionStorage.getItem("taskHistoryHighlightIds");if(e){this.selectedIdList=e.split(",").map(function(t){return Number(t)});sessionStorage.removeItem("taskHistoryHighlightIds")}this.getTaskHistoryList();this.getHistoryFilterList()},methods:{getTaskHistoryList:function t(){var e=this;return u()(s.a.mark(function t(){var a,i,r,n,o;return s.a.wrap(function t(s){while(1){switch(s.prev=s.next){case 0:s.prev=0;e.isLoading=true;a=e.getSearchParams();s.next=5;return e.$store.dispatch("job/ajaxGetJobList",{page:e.pagination.current,pagesize:e.pagination.limit,ordering:e.ordering,query:a});case 5:i=s.sent;e.pagination.count=i.data.count;r=[];n=new Set;i.data.list.forEach(function(t){n.add(t.created_by);t.start_time=Object(d["f"])(t.start_time);t.end_time=Object(d["f"])(t.end_time);t.timeout=Object(d["g"])(t.start_time,t.end_time);if(!["succeeded","failed"].includes(t.status)){r.push(t.id)}});o=c()(n).map(function(t){return{name:t,id:t}});e.tableData=i.data.list;e.filterData.forEach(function(t){if(t.id==="created_by"){t.children=o}});if(r.length){e.runningList=r;e.setPollHistoryList()}s.next=19;break;case 16:s.prev=16;s.t0=s["catch"](0);console.warn(s.t0);case 19:s.prev=19;e.isLoading=false;return s.finish(19);case 22:case"end":return s.stop()}}},t,null,[[0,16,19,22]])}))()},setPollHistoryList:function t(){var e=this;try{this.historyListTimer&&clearTimeout(this.historyListTimer);this.historyListTimer=setTimeout(u()(s.a.mark(function t(){var a,i,r;return s.a.wrap(function t(n){while(1){switch(n.prev=n.next){case 0:a=e.getSearchParams();n.next=3;return e.$store.dispatch("job/ajaxGetJobList",{pagesize:e.pagination.limit,query:a});case 3:i=n.sent;r=[];i.data.list.forEach(function(t){var a=e.tableData.find(function(e){return e.id===t.id});a.status=t.status;if(!["succeeded","failed"].includes(t.status)){r.push(t.id)}});if(r.length){e.runningList=r;e.setPollHistoryList()}case 7:case"end":return n.stop()}}},t)})),5e3)}catch(t){console.warn(t)}},getSearchParams:function t(){var e={};var a=this.initDateTimeRange;if(a[0]){e.start_time__gte=Object(d["e"])(a[0])}if(a[1]){e.start_time__lte=Object(d["e"])(a[1])}if(this.searchSelectValue.length){this.searchSelectValue.forEach(function(t){e[t.id]=t.values.map(function(t){return t.id})})}if(this.runningList.length){e.id=this.runningList}return e},getHistoryFilterList:function t(){var e=this;return u()(s.a.mark(function t(){var a;return s.a.wrap(function t(i){while(1){switch(i.prev=i.next){case 0:i.prev=0;i.next=3;return e.$store.dispatch("meta/ajaxGetHistoryFilterList");case 3:a=i.sent;e.filterData.forEach(function(t){var e;var i="".concat(t.id,"_choices");if(!a.data[i])return;var r=a.data[i].map(function(t){return{name:t.name,id:t.id}});(e=t.children).push.apply(e,c()(r))});e.searchSelectData=e.filterData;i.next=11;break;case 8:i.prev=8;i.t0=i["catch"](0);console.warn(i.t0);case 11:case"end":return i.stop()}}},t,null,[[0,8]])}))()},handlerRowClassName:function t(e){var a=e.row;if(this.selectedIdList.includes(a.id)){return"select-row"}},handleSortChange:function t(e){var a=e.prop,i=e.order;if(i==="ascending"){this.ordering=a}else if(i==="descending"){this.ordering="-".concat(a)}else{this.ordering=""}clearTimeout(this.historyListTimer);this.runningList=[];this.getTaskHistoryList()},handleRowClick:function t(e){this.$emit("getTaskDeatail",e);this.$store.commit("routeTaskHistoryDetail",e.id)},onDataPickerPick:function t(){this.getTaskHistoryList()},handleClearDate:function t(){this.initDateTimeRange=["",""];this.getTaskHistoryList()},onRetyr:function t(e){var a=this;return u()(s.a.mark(function t(){return s.a.wrap(function t(i){while(1){switch(i.prev=i.next){case 0:i.prev=0;a.runningList.push(e.id);e.status="loading";i.next=5;return a.$store.dispatch("job/ajaxRetryJob",{jobId:e.id,data:{job_task_id_list:[]}});case 5:a.setPollHistoryList();i.next=11;break;case 8:i.prev=8;i.t0=i["catch"](0);console.warn(i.t0);case 11:case"end":return i.stop()}}},t,null,[[0,8]])}))()},handlePageLimitChange:function t(e){clearTimeout(this.historyListTimer);this.runningList=[];this.pagination.current=1;this.pagination.limit=e;this.getTaskHistoryList()},handlePageChange:function t(e){clearTimeout(this.historyListTimer);this.runningList=[];this.pagination.current=e;this.getTaskHistoryList()}}};var m=p;var f=a(785);var v=a(10);var b=Object(v["a"])(m,i,r,false,null,"584e4907",null);var g=e["default"]=b.exports},567:function(t,e,a){},785:function(t,e,a){"use strict";var i=a(567);var r=a.n(i);var n=r.a}}]);