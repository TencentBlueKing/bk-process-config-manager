(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[16],{223:function(t,e,a){"use strict";a.r(e);var s=function(){var t=this;var e=t.$createElement;var a=t._self._c||e;return a("div",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:!Object.values(t.jobInfo).length},expression:"{ isLoading: !Object.values(jobInfo).length }"}],staticClass:"history-detail"},[a("section",{staticClass:"detail-config"},[a("div",{staticClass:"detail-config-header"},[a("i",{staticClass:"button-text gsekit-icon gsekit-icon-down-line",on:{click:t.handleRouterClick}}),t._v(" "),a("span",[t._v(t._s(t.$t("任务详情")+t.$t("：")))]),t._v(" "),Object.values(t.jobInfo).length?[a("span",[t._v(t._s(t.jobObject[t.jobInfo.job_object]+t.jobAction[t.jobInfo.job_action]))]),t._v(" "),a("span",{class:["perform-status",{success:t.jobInfo.status==="succeeded",fail:t.jobInfo.status==="failed"}]},[t._v("\n          "+t._s(t.executionStatus[t.jobInfo.status])+"\n        ")])]:[t._v(" "+t._s("--"))]],2),t._v(" "),a("div",{staticClass:"detail-config-couple"},[a("DetailList",{attrs:{"job-object":t.jobObject,"job-action":t.jobAction,"task-detail":t.jobInfo}})],1)]),t._v(" "),t.jobInfo.extra_data&&t.jobInfo.extra_data.failed_reason?[a("bk-exception",{staticClass:"exception-wrap-item",attrs:{type:"500"}},[a("span",[t._v(t._s(t.$t("创建任务失败")))]),t._v(" "),a("div",{staticClass:"text-wrap"},[t._v("\n        "+t._s(t.jobInfo.extra_data.failed_reason)+"\n      ")])])]:[a("section",{staticClass:"detail-search"},[a("div",{staticClass:"btn-section"},[a("bk-button",{directives:[{name:"test",rawName:"v-test",value:"retryAll",expression:"'retryAll'"}],attrs:{disabled:t.jobInfo.status!=="failed",loading:t.retryLoading},on:{click:t.onAllRetry}},[t._v("\n          "+t._s(t.$t("重试所有失败"))+"\n        ")]),t._v(" "),a("bk-dropdown-menu",{ref:"dropdownCopy",attrs:{trigger:"click","font-size":"medium",disabled:["running","pending"].includes(t.jobInfo.status)||t.copyLoading},on:{show:t.dropdownShow,hide:t.dropdownHide}},[a("bk-button",{directives:[{name:"test",rawName:"v-test.common",value:"more",expression:"'more'",modifiers:{common:true}}],staticClass:"copy-dropdown-btn",attrs:{slot:"dropdown-trigger",disabled:["running","pending"].includes(t.jobInfo.status)},slot:"dropdown-trigger"},[a("span",{staticClass:"icon-down-wrapper"},[a("span",[t._v(t._s(t.$t("复制")))]),t._v(" "),a("i",{class:["bk-icon icon-angle-down",{"icon-flip":t.isShowCopy}]})])]),t._v(" "),a("ul",{staticClass:"bk-dropdown-list",attrs:{slot:"dropdown-content"},slot:"dropdown-content"},t._l(t.copyTypeList,function(e,s){return a("li",{key:s+Date.now()},[a("a",{directives:[{name:"test",rawName:"v-test.common",value:"moreItem",expression:"'moreItem'",modifiers:{common:true}}],attrs:{href:"javascript:","test-key":e.key||"all"},on:{click:function(a){a.preventDefault();a.stopPropagation();t.handleCopy(e.key)}}},[t._v("\n                "+t._s(e.name)+"\n              ")])])}),0)],1)],1),t._v(" "),a("bk-search-select",{directives:[{name:"test",rawName:"v-test.common",value:"searchSelect",expression:"'searchSelect'",modifiers:{common:true}}],ref:"searchSelect",attrs:{"show-condition":false,data:t.searchSelectData},on:{"show-menu":t.handleSearchSelectShowMenu,change:t.handleSearchSelectChange},model:{value:t.searchSelectValue,callback:function(e){t.searchSelectValue=e},expression:"searchSelectValue"}})],1),t._v(" "),t.statusTabList.length?a("section",{staticClass:"tab-header"},t._l(t.statusTabList,function(e){return a("div",{directives:[{name:"test",rawName:"v-test",value:"tableTabItem",expression:"'tableTabItem'"}],key:e.err_code,class:["tab-item",{active:t.selectedTabCode===e.err_code}],on:{click:function(a){t.handleTabChange(e)}}},[e.err_code===0?a("span",{staticClass:"status-icon generated-status"}):e.err_code===1?a("span",{staticClass:"status-icon pending-status"}):e.err_code===3?a("span",{staticClass:"status-icon failed-status"}):e.err_code===4?a("span",{staticClass:"status-icon ignored-status"}):e.err_code===2?a("svg",{staticClass:"status-icon running-status",attrs:{"aria-hidden":"true"}},[a("use",{attrs:{"xlink:href":"#gsekit-icon-loading"}})]):a("span",{staticClass:"status-icon other-status"}),t._v(" "),a("span",{directives:[{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}],staticClass:"tab-item-name"},[t._v(t._s(e.message))]),t._v(" "),a("span",{staticClass:"tab-item-count"},[t._v(t._s(e.count))])])}),0):t._e(),t._v(" "),a("section",{staticClass:"detail-table"},[a("bk-table",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:t.isTableLoading},expression:"{ isLoading: isTableLoading }"}],attrs:{"auto-scroll-to-top":"","ext-cls":"king-table","max-height":t.$store.state.pageHeight-345,data:t.taskList,pagination:t.pagination},on:{"page-change":t.handlePageChange,"page-limit-change":t.handlePageLimitChange}},[a("bk-table-column",{attrs:{label:t.$t("集群"),prop:"set_name","render-header":t.renderFilterHeader},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.bk_set_name||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("模块"),prop:"template_name","render-header":t.renderFilterHeader},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.bk_module_name||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("服务实例"),"min-width":"180",prop:"server_instance"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.name||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("进程别名"),prop:"process_name","render-header":t.renderFilterHeader},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.bk_process_name||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:"process_id",prop:"bk_process_id"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.bk_process_id||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:"inst_id",prop:"inst_id",width:"70"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.extra_data.inst_id||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("进程优先级"),prop:"priority"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.priority||s.priority===0?s.priority:"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("内网IP"),prop:"bk_host_innerip",width:"125"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.bk_host_innerip||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("执行耗时"),prop:"timeout",width:"100"},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("span",[t._v(t._s(s.timeout||"--"))])]}}])}),t._v(" "),a("bk-table-column",{attrs:{label:t.$t("执行状态"),width:"140",prop:"status","render-header":t.renderFilterHeader},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return[a("div",{staticClass:"status-info"},[s.status==="succeeded"?a("StatusView",{attrs:{type:"success",text:t.$t("执行成功")}}):s.status==="failed"?[a("GenerateFailed",{attrs:{"failed-reason":s.extra_data.failed_reason,solutions:s.extra_data.solutions}})]:s.status==="ignored"?[a("GenerateFailed",{attrs:{"status-type":"ignored",text:t.$t("已忽略"),"failed-reason":s.extra_data.failed_reason,solutions:s.extra_data.solutions}})]:a("StatusView",{attrs:{type:"loading",text:t.$t("正在执行")}})],2)]}}])}),t._v(" "),t.showOperateColumn?a("bk-table-column",{attrs:{label:t.$t("操作"),"min-width":100},scopedSlots:t._u([{key:"default",fn:function(e){var s=e.row;return a("div",{on:{click:function(t){t.stopPropagation()}}},[a("bk-popover",{attrs:{disabled:!!s.instancesConfig||["running","pending"].includes(s.status),content:t.$t("没有绑定配置实例，暂无法查看")}},[a("bk-button",{staticStyle:{"margin-right":"6px"},attrs:{disabled:!s.instancesConfig||["running","pending"].includes(s.status),theme:"primary",text:""},on:{click:function(e){t.onCheckConfig(s)}}},[t._v("\n                "+t._s(t.$t("查看配置"))+"\n              ")])],1)],1)}}])}):t._e()],1)],1)],t._v(" "),a("ViewConfig",{attrs:{"instances-config":t.instancesConfig},on:{onCloseSide:t.onCloseSide}})],2)};var n=[];var i=a(11);var r=a.n(i);var o=a(37);var c=a.n(o);var l=a(3);var u=a.n(l);var d=a(7);var p=a.n(d);var b=function(){var t=this;var e=t.$createElement;var a=t._self._c||e;return a("div",{staticClass:"detail-list"},[a("div",{staticClass:"row"},[a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("任务ID")+t.$t("：")))]),t._v(" "),a("span",[t._v(t._s(t.taskDetail.id||"--"))])]),t._v(" "),a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("环境类型")+t.$t("：")))]),t._v(" "),a("span",[t._v(t._s(t.taskDetail.setEevName||"--"))])]),t._v(" "),a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("任务类型")+t.$t("：")))]),t._v(" "),a("span",[t._v(t._s(t.jobObject[t.taskDetail.job_object]+t.jobAction[t.taskDetail.job_action]||"--"))])]),t._v(" "),a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("操作范围")+t.$t("：")))]),t._v(" "),a("div",{directives:[{name:"test",rawName:"v-test",value:"expressionFilter",expression:"'expressionFilter'"},{name:"bk-overflow-tips",rawName:"v-bk-overflow-tips"}],staticClass:"button-text",on:{click:function(e){t.goProcessStatusPage(t.taskDetail.expression_scope)}}},[t._v("\n        "+t._s(t.taskDetail.expression||"--")+"\n      ")])])]),t._v(" "),a("div",{staticClass:"row"},[a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("执行账户")+t.$t("：")))]),t._v(" "),a("span",[t._v(t._s(t.taskDetail.created_by||"--"))])]),t._v(" "),a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("执行耗时")+t.$t("：")))]),t._v(" "),a("span",[t._v(t._s(t.taskDetail.timeout||"--"))])]),t._v(" "),a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("开始时间")+t.$t("：")))]),t._v(" "),a("span",[t._v(t._s(t.taskDetail.start_time||"--"))])]),t._v(" "),a("div",{staticClass:"couple"},[a("label",{staticClass:"couple-label"},[t._v(t._s(t.$t("结束时间")+t.$t("：")))]),t._v(" "),a("span",[t._v(t._s(t.taskDetail.end_time||"--"))])])])])};var _=[];var f={name:"TaskHistoryDetail",props:{jobAction:{type:Object,default:function t(){return{}}},jobObject:{type:Object,default:function t(){return{}}},taskDetail:{type:Object,default:function t(){return{}}}},methods:{goProcessStatusPage:function t(e){this.$router.push({path:"/process-manage/status",query:{expressionScope:JSON.stringify(e)}})}}};var v=f;var h=a(786);var m=a(10);var g=Object(m["a"])(v,b,_,false,null,"41c8a0e0",null);var k=g.exports;var w=a(636);var j=a(643);var C=a(19);var y=a(575);var x={name:"HistoryDetail",components:{ViewConfig:j["a"],DetailList:k,GenerateFailed:y["a"]},mixins:[w["a"]],props:{selectedConfig:{type:Object,default:null},jobObject:{type:Object,default:function t(){return{}}},jobAction:{type:Object,default:function t(){return{}}}},data:function t(){var e={succeeded:this.$t("执行成功"),failed:this.$t("执行失败"),running:this.$t("正在执行"),pending:this.$t("等待中")};return{statusTabList:[],selectedTabCode:null,taskList:[],jobInfo:{},pagination:{current:1,count:0,limit:50},instancesConfig:[],executionStatus:e,isTableLoading:false,isDataLoading:false,retryLoading:false,timer:null,executedList:["succeeded","failed","ignored"],copyLoading:false,copyTypeList:[{name:this.$t("所有IP"),key:""},{name:this.$t("被忽略IP"),key:"ignored"},{name:this.$t("失败IP"),key:"failed"},{name:this.$t("成功IP"),key:"succeeded"}],isShowCopy:false}},computed:{showOperateColumn:function t(){return this.jobInfo.job_object!=="process"}},watch:{selectedConfig:{handler:function t(e){if(!e)return;var a=this.setInfoDataType(e);if(a.is_ready&&!a.extra_data.failed_reason){this.getJobTaskStatistics();this.getFilterCondition()}this.jobInfo=a;this.isTableLoading=true},immediate:true}},beforeDestroy:function t(){clearTimeout(this.timer)},methods:{getJobTaskStatistics:function t(){var e=this;return p()(u.a.mark(function t(){var a,s;return u.a.wrap(function t(n){while(1){switch(n.prev=n.next){case 0:n.prev=0;n.next=3;return e.$store.dispatch("job/ajaxGetJobTaskStatistics",{jobId:e.$route.params.jobId});case 3:a=n.sent;e.statusTabList=a.data||[];s=e.statusTabList.map(function(t){return t.err_code});if(!s.includes(e.selectedTabCode)){e.selectedTabCode=a.data[0].err_code}e.getTaskHistoryDetail();n.next=13;break;case 10:n.prev=10;n.t0=n["catch"](0);console.warn(n.t0);case 13:case"end":return n.stop()}}},t,null,[[0,10]])}))()},getTaskHistoryDetail:function t(){var e=this;return p()(u.a.mark(function t(){var a,s,n,i,r;return u.a.wrap(function t(o){while(1){switch(o.prev=o.next){case 0:o.prev=0;a=e.getSearchParams();o.next=4;return e.$store.dispatch("job/ajaxGetJobTaskList",{jobId:e.$route.params.jobId,data:a});case 4:s=o.sent;n=s.data,i=n.list,r=n.count;i.forEach(function(t){var a=t.extra_data.process_info;t.bk_set_name=a.set.bk_set_name;t.bk_module_name=a.module.bk_module_name;t.name=a.service_instance.name;t.bk_process_name=a.process.bk_process_name;t.bk_host_innerip=a.host.bk_host_innerip;t.priority=a.process.priority;if(e.executedList.includes(t.status)){t.timeout=Object(C["g"])(t.start_time,t.end_time)}var s=t.extra_data.config_instances;if(s&&s.length){t.instancesConfig=[];s.forEach(function(e){t.instancesConfig.push({name:e.template_name,label:e.file_name,id:e.id})})}});e.taskList=i;e.pagination.count=r;if(["pending","running"].includes(e.jobInfo.status)){e.getJobStatus()}else{e.retryLoading=false}o.next=15;break;case 12:o.prev=12;o.t0=o["catch"](0);console.warn(o.t0);case 15:o.prev=15;e.isTableLoading=false;return o.finish(15);case 18:case"end":return o.stop()}}},t,null,[[0,12,15,18]])}))()},setInfoDataType:function t(e){e.start_time=Object(C["f"])(e.start_time);e.end_time=Object(C["f"])(e.end_time);e.timeout=Object(C["g"])(e.start_time,e.end_time);var a=e.expression_scope.bk_set_env;var s="";switch(a){case"1":s=this.$t("测试");break;case"2":s=this.$t("体验");break;case"3":s=this.$t("正式");break}e.setEevName=s;return e},getSelectedConfig:function t(){var e=this;return p()(u.a.mark(function t(){var a,s,n;return u.a.wrap(function t(i){while(1){switch(i.prev=i.next){case 0:a=e.$route.params.jobId;if(a){i.next=3;break}return i.abrupt("return");case 3:i.next=5;return e.$store.dispatch("job/ajaxGetJobDetail",{jobId:a});case 5:s=i.sent;n=e.setInfoDataType(s.data);e.jobInfo=n;case 8:case"end":return i.stop()}}},t)}))()},getJobStatus:function t(){var e=this;try{clearTimeout(this.timer);this.timer=setTimeout(p()(u.a.mark(function t(){return u.a.wrap(function t(a){while(1){switch(a.prev=a.next){case 0:e.getSelectedConfig();e.getJobTaskStatistics();case 2:case"end":return a.stop()}}},t)})),3e3)}catch(t){console.warn(t)}},getFilterCondition:function t(){var e=this;return p()(u.a.mark(function t(){var a,s,n,i,r,o,l,d;return u.a.wrap(function t(u){while(1){switch(u.prev=u.next){case 0:u.prev=0;u.next=3;return e.$store.dispatch("meta/ajaxGetTaskFilterCondition",{jobId:e.$route.params.jobId});case 3:a=u.sent;s=[];n=0,i=Object.entries(a.data);case 6:if(!(n<i.length)){u.next=27;break}r=c()(i[n],2),o=r[0],l=r[1];d={children:l,multiable:true};u.t0=o;u.next=u.t0==="module"?12:u.t0==="process"?15:u.t0==="set"?18:u.t0==="status_choices"?21:23;break;case 12:d.id="template_name";d.name=e.$t("模块");return u.abrupt("break",23);case 15:d.id="process_name";d.name=e.$t("进程别名");return u.abrupt("break",23);case 18:d.id="set_name";d.name=e.$t("集群");return u.abrupt("break",23);case 21:d.id="status";d.name=e.$t("状态");case 23:s.push(d);case 24:n++;u.next=6;break;case 27:e.filterData=s;e.searchSelectData=s;u.next=34;break;case 31:u.prev=31;u.t1=u["catch"](0);console.warn(u.t1);case 34:case"end":return u.stop()}}},t,null,[[0,31]])}))()},getSearchParams:function t(){var e={page:this.pagination.current,pagesize:this.pagination.limit,err_code:this.selectedTabCode};if(this.searchSelectValue.length){this.searchSelectValue.forEach(function(t){switch(t.id){case"set_name":e.bk_set_ids=t.values.map(function(t){return t.id});break;case"template_name":e.bk_module_ids=t.values.map(function(t){return t.id});break;case"process_name":e.bk_process_names=t.values.map(function(t){return t.id});break;case"status":e.statuses=t.values.map(function(t){return t.id})}})}return e},onCheckConfig:function t(e){this.instancesConfig=e.instancesConfig},onCloseSide:function t(){this.instancesConfig=null},handleTabChange:function t(e){this.selectedTabCode=e.err_code;this.isTableLoading=true;this.getTaskHistoryDetail()},dropdownShow:function t(){this.isShowCopy=true},dropdownHide:function t(){this.isShowCopy=false},handleCopy:function t(e){var a=this;return p()(u.a.mark(function t(){var s,n,i,o;return u.a.wrap(function t(c){while(1){switch(c.prev=c.next){case 0:c.prev=0;a.copyLoading=true;a.$refs.dropdownCopy.hide();c.next=5;return a.$store.dispatch("job/ajaxGetSearchIp",{jobId:a.$route.params.jobId,status:e});case 5:s=c.sent;if(s){n={theme:"error",message:a.$t("没有符合条件的IP")};if(s.data&&s.data.length){i=s.data.map(function(t){return t.bk_host_innerip}).join("\n");o=Object(C["d"])(i);if(o){r()(n,{theme:"success",message:a.$t("IP复制成功",{num:s.data.length})})}}a.$bkMessage(n)}c.next=12;break;case 9:c.prev=9;c.t0=c["catch"](0);console.warn(c.t0);case 12:c.prev=12;a.copyLoading=false;return c.finish(12);case 15:case"end":return c.stop()}}},t,null,[[0,9,12,15]])}))()},onRetry:function t(e){var a=this;return p()(u.a.mark(function t(){return u.a.wrap(function t(s){while(1){switch(s.prev=s.next){case 0:try{e.status="running";a.$store.dispatch("job/ajaxRetryJob",{jobId:e.job_id,data:{job_task_id_list:[e.id]}}).then(function(){a.getJobStatus()})}catch(t){console.warn(t)}case 1:case"end":return s.stop()}}},t)}))()},onAllRetry:function t(){var e=this;return p()(u.a.mark(function t(){return u.a.wrap(function t(a){while(1){switch(a.prev=a.next){case 0:a.prev=0;e.retryLoading=true;e.taskList.forEach(function(t){if(t.status==="failed"){t.status="running"}});a.next=5;return e.$store.dispatch("job/ajaxRetryJob",{jobId:e.jobInfo.id,data:{job_task_id_list:[]}}).then(function(){e.getJobStatus()});case 5:a.next=10;break;case 7:a.prev=7;a.t0=a["catch"](0);console.warn(a.t0);case 10:case"end":return a.stop()}}},t,null,[[0,7]])}))()},handleRouterClick:function t(){var e=this.$router.__from_name;if(e){if(e==="process-manage-release"){this.$store.commit("routeProcessManageStatus")}else if(e==="config-file-template-distribute"){this.$store.commit("routeConfigTemplateList")}else{this.$router.back()}}else{this.$store.commit("routeTaskHistoryList")}},handlePageChange:function t(e){this.isTableLoading=true;this.pagination.current=e;this.getTaskHistoryDetail()},handlePageLimitChange:function t(e){this.isTableLoading=true;this.pagination.current=1;this.pagination.limit=e;this.getTaskHistoryDetail()}}};var $=x;var S=a(787);var I=Object(m["a"])($,s,n,false,null,"070cec9c",null);var T=e["default"]=I.exports},568:function(t,e,a){},569:function(t,e,a){},786:function(t,e,a){"use strict";var s=a(568);var n=a.n(s);var i=n.a},787:function(t,e,a){"use strict";var s=a(569);var n=a.n(s);var i=n.a}}]);